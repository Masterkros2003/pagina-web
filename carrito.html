<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrito de Compras y Pago | SNEAKERS</title>
    <link rel="icon" type="image/x-icon" href="./favicon.ico">
    <!-- Bootstrap CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Iconos de Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- CSS Unificado (Resultado de SASS) -->
    <link rel="stylesheet" href="./style.css">
    <audio autoplay loop>
        <source src="videoplayback.m4a" type="audio/mpeg">
    </audio>
</head>

<body class="bg-light d-flex flex-column min-vh-100">

    <!-- HEADER (NavBar) con Bootstrap -->
    <header>
        <nav class="navbar navbar-expand-lg bg-white border-bottom shadow-sm">
            <div class="container-xl">
                <a class="navbar-brand fs-4" href="./index.html"><strong>SNEAKERS</strong></a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
                    <ul class="navbar-nav">
                         <li class="nav-item">
                            <a class="nav-link" href="./index.html">Inicio</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="./productos.html">Productos</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="./tienda.html">Tienda</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="./promociones.html">Promociones</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="./carrito.html">Carrito <i class="bi bi-cart"></i></a> 
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <main class="container-xl py-5 flex-grow-1">
        <div class="row g-4">
            
            <!-- Columna de Productos del Carrito (8 columnas en desktop) -->
            <div class="col-lg-8">
                <div class="bg-white p-4 shadow-sm rounded-8">
                    <h2 class="mb-4 cart-header text-primary">Tu Carrito de Compras</h2>

                    <!-- Encabezados de la Tabla de Productos -->
                    <div class="row row-cols-5 fw-bold text-muted small pb-2 border-bottom d-none d-md-flex">
                        <div class="col-5">Producto</div>
                        <div class="col-2 text-end">Precio</div>
                        <div class="col-2 text-center">Cantidad</div>
                        <div class="col-2 text-end">Subtotal</div>
                        <div class="col-1"></div>
                    </div>

                    <!-- LISTA DE PRODUCTOS DINÁMICA -->
                    <div id="cart-items-list" class="mt-3">
                        <!-- Contenido dinámico inyectado aquí por JavaScript -->
                        <div class="p-3 text-center text-muted">Cargando carrito...</div>
                    </div>
                </div>
            </div>

            <!-- Columna de Resumen del Carrito (4 columnas en desktop) -->
            <div class="col-lg-4">
                <div class="p-4 shadow-sm rounded-8 cart-summary-card h-100">
                    <h3 class="mb-3 fw-bold">Resumen del Pedido</h3>
                    
                    <ul class="list-group list-group-flush mb-4">
                        <!-- Subtotal -->
                        <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent px-0">
                            Subtotal de Productos:
                            <span id="cart-subtotal" class="fw-bold">0,00 €</span>
                        </li>
                        <!-- Envío -->
                        <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent px-0">
                            Envío (Standard):
                            <span id="cart-shipping" class="text-muted">15,00 €</span>
                        </li>
                        <!-- Impuestos -->
                        <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent px-0">
                            Impuestos (IVA 21%):
                            <span id="cart-tax" class="text-muted">0,00 €</span>
                        </li>
                        <!-- Total -->
                        <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent px-0 pt-3 cart-total-line">
                            <span class="fs-5 fw-bold">Total a Pagar:</span>
                            <span id="cart-total" class="fs-5 fw-bold text-primary">0,00 €</span>
                        </li>
                    </ul>

                    <!-- Botón de Checkout que activa el modal -->
                    <button 
                        id="checkout-btn"
                        class="btn btn-lg w-100 btn-primary-custom" 
                        onclick="showConfirmationModal()"
                    >
                        FINALIZAR COMPRA
                    </button>

                    <p class="text-center small text-muted mt-3">
                        <i class="bi bi-info-circle me-1"></i> Envío gratuito en pedidos superiores a 300 €.
                    </p>
                </div>
            </div>

        </div>
    </main>
    
    <!-- Modal de Confirmación de Compra de Bootstrap -->
    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmationModalLabel"><i class="bi bi-cart-check-fill me-2"></i> ¡Pedido Confirmado!</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <i class="bi bi-check-circle-fill modal-icon mb-3"></i>
                    <p class="fs-5 fw-medium">Gracias por tu compra en SNEAKERS.</p>
                    <p class="text-muted">Recibirás un email de confirmación en breve. Tu pedido se enviará en las próximas 24 horas.</p>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-primary btn-primary-custom" data-bs-dismiss="modal" onclick="clearCartAndRedirect()">Volver al Inicio</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Seguir Comprando</button>
                </div>
            </div>
        </div>
    </div>


    <!-- FOOTER con Bootstrap (Mismo que index.html) -->
    <footer class="text-center text-lg-start bg-light text-muted pt-4 mt-auto">
        <div class="container-xl">
            <section class="d-flex justify-content-center justify-content-lg-between p-4 border-bottom">
                <div class="me-5 d-none d-lg-block">
                    <span>Conéctate con nosotros en las redes sociales:</span>
                </div>
                <div>
                    <a href="#" class="me-4 text-reset"><i class="bi bi-facebook fs-5"></i></a>
                    <a href="#" class="me-4 text-reset"><i class="bi bi-twitter fs-5"></i></a>
                    <a href="#" class="me-4 text-reset"><i class="bi bi-instagram fs-5"></i></a>
                    <a href="#" class="me-4 text-reset"><i class="bi bi-linkedin fs-5"></i></a>
                </div>
            </section>
            <section class="pt-4">
                <div class="row mt-3">
                    <div class="col-md-3 col-lg-4 col-xl-3 mx-auto mb-4">
                        <h6 class="text-uppercase fw-bold mb-4">SNEAKERS</h6>
                        <p>Tu tienda online de zapatillas exclusivas.</p>
                    </div>
                    <div class="col-md-2 col-lg-2 col-xl-2 mx-auto mb-4">
                        <h6 class="text-uppercase fw-bold mb-4">Productos</h6>
                        <p><a href="./productos.html" class="text-reset text-decoration-none">Zapatillas</a></p>
                        <p><a href="./tienda.html" class="text-reset text-decoration-none">Ropa</a></p>
                    </div>
                    <div class="col-md-3 col-lg-2 col-xl-2 mx-auto mb-4">
                        <h6 class="text-uppercase fw-bold mb-4">Información</h6>
                        <p><a href="#!" class="text-reset text-decoration-none">Mi Cuenta</a></p>
                        <p><a href="#!" class="text-reset text-decoration-none">Ayuda</a></p>
                    </div>
                    <div class="col-md-4 col-lg-3 col-xl-3 mx-auto mb-md-0 mb-4">
                        <h6 class="text-uppercase fw-bold mb-4">Contacto</h6>
                        <p><i class="bi bi-house-door-fill me-3"></i> Sevilla, ES</p>
                        <p><i class="bi bi-envelope-fill me-3"></i> Infojordan@gmail.com</p>
                    </div>
                </div>
            </section>
            <div class="text-center p-4 bg-white">
                © 2025 Copyright:
                <a class="text-reset fw-bold text-decoration-none" href="https://pagina-web-gold-theta.vercel.app/">SNEAKERS</a>
            </div>
        </div>
    </footer>


    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            renderCartItems();
        });

        // Función para formatear números como moneda (€)
        function formatCurrency(value) {
            return value.toFixed(2).replace('.', ',') + ' €';
        }

        // Función para mostrar el modal de confirmación
        function showConfirmationModal() {
            const checkoutBtn = document.getElementById('checkout-btn');
            const cart = JSON.parse(localStorage.getItem('shoppingCart')) || [];

            if (cart.length === 0) {
                // Si el carrito está vacío, no mostrar el modal de éxito, sino un mensaje de error simulado
                const alertHtml = `
                    <div class="alert alert-danger d-flex align-items-center" role="alert">
                        <i class="bi bi-exclamation-triangle-fill flex-shrink-0 me-2"></i>
                        <div>Tu carrito está vacío. Añade productos para finalizar la compra.</div>
                    </div>
                `;
                // Usar temporalmente el área de la lista para mostrar el error
                document.getElementById('cart-items-list').innerHTML = alertHtml;
                // Opcional: deshabilitar el botón de nuevo
                checkoutBtn.disabled = true;
                return;
            }

            // Si hay productos, mostrar el modal de éxito de Bootstrap
            const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
            modal.show();
        }

        // Función para vaciar el carrito y redirigir
        function clearCartAndRedirect() {
            localStorage.removeItem('shoppingCart');
            window.location.href = './index.html';
        }

        // Función para eliminar un producto del carrito
        function removeFromCart(productId) {
            let cart = JSON.parse(localStorage.getItem('shoppingCart')) || [];
            cart = cart.filter(item => item.id !== productId);
            localStorage.setItem('shoppingCart', JSON.stringify(cart));
            renderCartItems();
        }

        // Función para renderizar los elementos del carrito
        function renderCartItems() {
            const cartList = document.getElementById('cart-items-list');
            const checkoutBtn = document.getElementById('checkout-btn');
            const cart = JSON.parse(localStorage.getItem('shoppingCart')) || [];
            cartList.innerHTML = ''; 

            if (cart.length === 0) {
                cartList.innerHTML = '<div class="p-3 text-center text-muted">Tu carrito está vacío.</div>';
                calculateCartTotals(0);
                checkoutBtn.disabled = true;
                return;
            } else {
                checkoutBtn.disabled = false;
            }

            let totalSubtotal = 0;

            cart.forEach(product => {
                const itemSubtotal = product.price * product.quantity;
                totalSubtotal += itemSubtotal;

                const row = document.createElement('div');
                row.className = 'row row-cols-5 align-items-center py-3 border-bottom';
                row.dataset.id = product.id;
                row.dataset.price = product.price;

                row.innerHTML = `
                    <!-- Producto y Detalles (5 columnas en móvil, 5 en desktop) -->
                    <div class="col-5">
                        <div class="d-flex align-items-center">
                            <img src="${product.image}" alt="${product.name}" class="me-3" style="width: 50px; height: 50px; object-fit: contain;">
                            <div>
                                <h4 class="mb-0 fw-bold fs-6">${product.name}</h4>
                                <small class="text-muted d-block">ID: ${product.id}</small>
                            </div>
                        </div>
                    </div>
                    <!-- Precio Unitario (Escondido en móvil, 2 en desktop) -->
                    <div class="col-2 text-end d-none d-md-block">${formatCurrency(product.price)}</div>
                    <!-- Cantidad (2 columnas) -->
                    <div class="col-4 col-md-2">
                        <input type="number" value="${product.quantity}" min="1" class="form-control form-control-sm text-center" onchange="updateCartItem(this)">
                    </div>
                    <!-- Subtotal (2 columnas) -->
                    <div class="col-2 text-end fw-bold">${formatCurrency(itemSubtotal)}</div>
                    <!-- Botón Eliminar (1 columna) -->
                    <div class="col-1 text-center">
                        <button class="btn btn-sm text-danger" onclick="removeFromCart('${product.id}')" title="Eliminar Producto">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                `;
                cartList.appendChild(row);
            });

            calculateCartTotals(totalSubtotal);
        }

        // Función que se ejecuta al cambiar la cantidad de un producto
        function updateCartItem(inputElement) {
            const row = inputElement.closest('.row');
            const productId = row.dataset.id;
            const quantity = parseInt(inputElement.value);

            if (quantity < 1 || isNaN(quantity)) {
                inputElement.value = 1;
                // Evitar el return para que se recalcule con el valor corregido.
            }

            let cart = JSON.parse(localStorage.getItem('shoppingCart')) || [];
            const itemIndex = cart.findIndex(item => item.id === productId);

            if (itemIndex !== -1) {
                cart[itemIndex].quantity = parseInt(inputElement.value);
                localStorage.setItem('shoppingCart', JSON.stringify(cart));
            }

            renderCartItems();
        }

        // Función principal para calcular todos los totales
        function calculateCartTotals(totalSubtotal) {
            const SHIPPING_COST = 15.00;
            const FREE_SHIPPING_THRESHOLD = 300.00;
            const TAX_RATE = 0.21;

            let finalShipping = SHIPPING_COST;
            if (totalSubtotal >= FREE_SHIPPING_THRESHOLD) {
                finalShipping = 0.00;
            }

            const tax = totalSubtotal * TAX_RATE;
            const finalTotal = totalSubtotal + finalShipping + tax;

            document.getElementById('cart-subtotal').textContent = formatCurrency(totalSubtotal);
            document.getElementById('cart-shipping').textContent = formatCurrency(finalShipping);
            document.getElementById('cart-tax').textContent = formatCurrency(tax);
            document.getElementById('cart-total').textContent = formatCurrency(finalTotal);
        }
    </script>
</body>
</html>